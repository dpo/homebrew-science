language: ruby
matrix:
  include:
    - env: OSX=10.11
      os: osx
      osx_image: xcode8
      rvm: system
    - os: linux
      rvm: system
      sudo: required
      dist: trusty  # for gfortran-6

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-6
      - g++-6
      - gfortran-6
  apt_packages:
    - build-essential
    - python-setuptools
    - m4

before_install:
  - if [ -f ".git/shallow" ]; then
      travis_retry git fetch --unshallow;
    fi
  - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then
      sudo chown -R "$USER" "$(brew --repo)";
    else
      sudo mkdir -p /home/linuxbrew;
      sudo chown "$USER:" /home/linuxbrew;
      LINUXBREW=/home/linuxbrew/.linuxbrew;
      git clone https://github.com/Linuxbrew/brew.git $LINUXBREW;
      export PATH="$LINUXBREW/bin:$PATH";
      gccver=$(gcc -dumpversion |cut -d. -f1,2);
      ln -s $(which gcc) $LINUXBREW/bin/gcc-${gccver};
      ln -s $(which g++) $LINUXBREW/bin/g++-$(g++ -dumpversion |cut -d. -f1,2);
      ln -s $(which gfortran-${gccver}) $LINUXBREW/bin/gfortran-${gccver};
      ln -s $(which gfortran-${gccver}) $LINUXBREW/bin/gfortran;
    fi
  - git -C "$(brew --repo)" reset --hard origin/master;
  - git -C "$(brew --repo)" clean -qxdff;
  - brew update || brew update;
  - mkdir -p "$(brew --repo)/Library/Taps/homebrew";
  - ln -s "$TRAVIS_BUILD_DIR" "$(brew --repo)/Library/Taps/homebrew/homebrew-science";
  - cd "$(brew --repo)/Library/Taps/homebrew/homebrew-science";
  - for tap in homebrew/python homebrew/x11 homebrew/dupes homebrew/versions; do brew tap $tap; done;
  - export TRAVIS_BUILD_DIR="$(brew --repo)/Library/Taps/homebrew/homebrew-science";
  - env | grep TRAVIS | tee /tmp/travis.env

install:
  - export HOMEBREW_DEVELOPER="1"
  - ulimit -n 1024

script:
  - brew test-bot --tap=homebrew/science;

notifications:
  email:
    on_success: never
    on_failure: never
